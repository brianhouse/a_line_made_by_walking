{% extends 'page.html' %}

{% block head %}
    <script type="text/javascript">

        var walk_index = null;
        var num_walks = 0;

        var map = null;
        var marker_layer = null;        
        var walk_data = null;

        var context = null;
        var buffers = {};  
        var master_gain_node = null;      

        var accel_data = [];
        var geo_data = [];
        var start_time = null;
        var stop_time = null;
        var geo_interval = null;

        function loadSound (name, url) {
            console.log("loadSound");
            var request = new XMLHttpRequest();
            request.open('GET', url, true);
            request.responseType = 'arraybuffer';
            request.onload = function() {
                context.decodeAudioData(request.response, function(buffer) {
                    buffers[name] = buffer;
                    console.log("Loaded " + name + " (" + url +")");                    
                }, null);
            }
            request.send();
        }

        function playSound (name, time, volume) {
            console.log("play " + name + " at " + time);
            buffer = buffers[name];
            var source = context.createBufferSource();       // creates a sound source
            source.buffer = buffer;                          // tell the source which sound to play
            var gain_node = context.createGainNode();        // create a gain node
            source.connect(gain_node);                       // connect the gain to the source
            gain_node.gain.value = volume;                   // set the volume
            gain_node.connect(master_gain_node);
            source.noteOn(time);                             // play the source in x seconds
        }                

        function timestamp () {
            return new Date().getTime()
        }

        function checkSelection () {
            console.log("checkSelection");
            walk_index = $('#walk_select option:selected').val();
            num_walks = $('#walk_select option').length;
            if (num_walks <= 1 || walk_index.length) {
                $('#start_btn').show();
                loadWalk();
            } else {
                $('#start_btn').hide();
            }
        }

        function loadWalk () {
            console.log("loadWalk");
            $.ajax({
                type: 'GET',
                url: 'sequence.py',
                data: {'index': walk_index},
                dataType: 'json',
                success: function (data, textStatus, jqXHR) {
                    walk_data = data;
                    var start_location = data['geo_data'][0];
                    var stop_location = data['geo_data'][data['geo_data'].length - 1];
                    markers = [];
                    markers.push({  geometry: {coordinates: start_location}, 
                                    properties: {'marker-color': '#000', 'marker-symbol': 'circle', 'marker-size': 'large'}
                                });                    
                    markers.push({  geometry: {coordinates: stop_location}, 
                                    properties: {'marker-color': '#000', 'marker-symbol': 'embassy', 'marker-size': 'large'}
                                });    
                    for (var i=0; i<data['geo_data'].length - 2; i++) {
                        markers.push({  geometry: {coordinates: data['geo_data'][i]},
                                        properties: {'marker-color': '#9cf', 'marker-size': 'small', 'image': "http://upload.wikimedia.org/wikipedia/commons/2/2a/Dot.png"}
                                    });                        
                    }                
                    marker_layer.features(markers);
                    // .factory(function(f) {
                    //     if (f.properties.image) {
                    //         var img = document.createElement('img');
                    //         img.className = 'marker-image';
                    //         img.setAttribute('src', f.properties.image);
                    //         return img;
                    //     }
                    // });
                    map.zoom(17).center({ lon: start_location[0], lat: start_location[1] });                                        
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(jqXHR);                    
                    alert("Sequence request failed:\n" + errorThrown);
                    window.location.reload();
                }
            }); 
        }        

        function startWalk () {
            console.log("startWalk");
            $('#walk_select').hide();
            $('#start_btn').hide();            
            playSound('left', 0, 0.0); // iOS needs this
            playSound('right', 0, 0.0); // iOS needs this
            startLog();
        }

        function startLog () {
            console.log("startLog");
            $('#stop_btn').show();
            sequence = walk_data['steps'];
            var audio_start_time = context.currentTime;
            for (var i=0; i<4; i++) {
                if (i % 2 == 0) {
                    playSound('left', audio_start_time + i, 1.0);
                } else {
                    playSound('right', audio_start_time + i, 1.0);
                }
            }
            for (note_index in sequence) {
                var note = sequence[note_index];
                var time = audio_start_time + (note[0] / 1000.0) + 4;
                var name = note[1];                        
                playSound(name, time, 1.0);
            }
            setTimeout(startRecording, 4000 - 500); // half second for the accelerometer to get going
        }

        function startRecording () {
            console.log("startRecording");
            $('#readings').show();
            getGeoLocation();
            geo_interval = setInterval(getGeoLocation, 10000);            
            start_time = timestamp();
            window.ondevicemotion = function(event) {
                var d = [timestamp(), event.accelerationIncludingGravity.x, event.accelerationIncludingGravity.y, event.accelerationIncludingGravity.z];                
                $('#display_x').html(d[1]);
                $('#display_y').html(d[2]);
                $('#display_z').html(d[3]);
                accel_data.push(d);
            }
        }

        function getGeoLocation () {
            console.log("getGeoLocation");
            navigator.geolocation.getCurrentPosition(receiveGeoLocation);
        }

        function receiveGeoLocation (location) {
            geo_data.push([location.coords.longitude, location.coords.latitude]);
            map.zoom(17).center({lon: location.coords.longitude, lat: location.coords.latitude});
        }                                

        function stopWalk () {
            console.log("stopWalk");
            stop_time = timestamp();
            window.ondevicemotion = function(event) { };            
            master_gain_node.gain.value = 0.0;
            getGeoLocation();
            clearInterval(geo_interval);
            sendLog();
        }

        function sendLog () {
            console.log("sendLog");
            $('#stop_btn').hide();
            $('#readings').hide();
            var duration = stop_time - start_time;
            var walk_data = {'accel_data': accel_data, 'geo_data': geo_data, 'start_time': start_time, 'duration': duration};
            walk_data = JSON.stringify(walk_data);            
            $.ajax({
                type: 'POST',
                url: 'index.py', 
                data: {'walk_data': walk_data}, 
                success: function () {
                    alert("Success!");
                    window.location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("Log failed: " + errorThrown);
                    window.location.reload();
                }
            });
        }

        $(document).ready(function() {                   

            map = mapbox.map('map');
            map.addLayer(mapbox.layer().id('brianhouse.map-124z30te'));
            map.ui.zoomer.add();

            marker_layer = mapbox.markers.layer()
            mapbox.markers.interaction(marker_layer);
            map.addLayer(marker_layer);            

            $('#start_btn').hide();
            $('#stop_btn').hide();
            $('#readings').hide();     

            navigator.geolocation.getCurrentPosition(function (location) { 
                map.zoom(17).center({lon: location.coords.longitude, lat: location.coords.latitude});
            }); // also for getting permission out of the way                   

            try {
                context = new webkitAudioContext();
                master_gain_node = context.createGainNode();
                master_gain_node.connect(context.destination);          // connect the gain to the destination
            } catch(e) {
                alert("Web Audio API is not supported in this browser");
            }            

            loadSound('left', "left.wav");
            loadSound('right', "right.wav");    

            checkSelection();        

        });  

    </script>
{% endblock head %}

{% block body %}

    <div id='map'></div>

    <select id="walk_select" onChange="checkSelection()" class="select">
        <option value=""></option>
    {% for timestamp, date in options | dictsort | reverse %}
        <option value="{{ timestamp}}">{{ date }}</a>
    {% endfor %}
    </select>

    <div id="readings">
        X: <span id="display_x"></span><br />
        Y: <span id="display_y"></span><br />
        Z: <span id="display_z"></span><br />
    </div>

    <input id="start_btn" class="btn" type="button" onClick="startWalk()" value="START" />
    <input id="stop_btn" class="btn" type="button" onClick="stopWalk()" value="STOP" />

{% endblock body %}

