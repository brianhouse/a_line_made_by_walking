{% extends 'page.html' %}

{% block head %}
    <script type="text/javascript">

        var walk_data = [];
        var walk_index = null;

        var context = null;
        var buffers = {};        

        function timestamp () {
            return new Date().getTime()
        }

        function checkSelection () {
            walk_index = $('#walk_select option:selected').val();
            if (walk_index.length) {
                $('#start_btn').show();
            } else {
                $('#start_btn').hide();
            }
        }

        function activateAudio () {
            playSound('left', 0);
            startLog();
        }

        function startLog () {
            $('#walk_select').hide();
            $('#start_btn').hide();
            $('#stop_btn').show();
            $('#readings').show();
            walk_index = $('#walk_select option:selected').val();
            $.ajax({
                type: 'GET',
                url: 'sequence.py',
                data: {'index': walk_index},
                dataType: 'json',
                success: function (sequence, textStatus, jqXHR) {
                    for (var i=0; i<4; i++) {
                        if (i % 2 == 0) {
                            playSound('left', i);    // should be a count/click sound
                        } else {
                            playSound('right', i);
                        }
                    }
                    for (note_index in sequence) {
                        var note = sequence[note_index];
                        var time = (note[0] / 1000.0) + 4;
                        var name = note[1];                        
                        playSound(name, time);
                    }
                    window.ondevicemotion = function(event) {
                        var d = [timestamp(), event.accelerationIncludingGravity.x, event.accelerationIncludingGravity.y, event.accelerationIncludingGravity.z];                
                        $('#display_x').html(d[1]);
                        $('#display_y').html(d[2]);
                        $('#display_z').html(d[3]);
                        walk_data.push(d);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("Sequence request failed: " + textStatus);
                    $('#walk_select').show();
                    $('#start_btn').show();     
                    $('#stop_btn').hide();                    
                }
            }); 
        }

        function stopLog () {
            $('#stop_btn').hide();
            $('#readings').hide();
            window.ondevicemotion = function(event) { };
            walk_data = JSON.stringify(walk_data);            
            $.ajax({
                type: 'POST',
                url: 'index.py', 
                data: {'walk_data': walk_data}, 
                success: function () {
                    alert("Success!");
                    window.location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("Log failed: " + textStatus);
                    walk_data = [];
                    $('#walk_select').show();
                    $('#start_btn').show();                    
                }
            });
        }

        function loadSound (name, url) {
            var request = new XMLHttpRequest();
            request.open('GET', url, true);
            request.responseType = 'arraybuffer';
            request.onload = function() {
                context.decodeAudioData(request.response, function(buffer) {
                    buffers[name] = buffer;
                    console.log("Loaded " + name + " (" + url +")");                    
                }, null);
            }
            request.send();
        }

        function playSound (name, time) {
            console.log('play ' + name + ' at ' + time);
            buffer = buffers[name];
            var source = context.createBufferSource(); // creates a sound source
            source.buffer = buffer;                    // tell the source which sound to play
            source.connect(context.destination);       // connect the source to the context's destination (the speakers)
            source.noteOn(time);                       // play the source now
        }        

        $(document).ready(function() {                   
            $('#start_btn').hide();
            $('#stop_btn').hide();
            $('#readings').hide();            

            try {
                context = new webkitAudioContext();
            } catch(e) {
                alert("Web Audio API is not supported in this browser");
            }            

            loadSound('left', "left.wav");
            loadSound('right', "right.wav");            
        });  

    </script>
{% endblock head %}

{% block body %}

    <table width="100%" height="100%"><tr><td align="center" valign="center">

    <select id="walk_select" onChange="checkSelection()">
        <option value=""></option>
    {% for timestamp, date in options.items() %}
        <option value="{{ timestamp}}">{{ date }}</a>
    {% endfor %}
    </select>
    <br />

    <input id="start_btn" type="button" onClick="activateAudio()" value="START" />
    <input id="stop_btn" type="button" onClick="stopLog()" value="STOP" />

    <div id="readings">
        X: <span id="display_x"></span><br />
        Y: <span id="display_y"></span><br />
        Z: <span id="display_z"></span><br />
    </div>

    </td></tr></table>    
{% endblock body %}

