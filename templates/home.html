{% extends 'page.html' %}

{% block head %}
    <script type="text/javascript">

        var walk_index = null;
        var num_walks = 0;

        var context = null;
        var buffers = {};        

        var accel_data = [];
        var start_time = null;
        var start_lon = null;
        var start_lat = null;
        var stop_lon = null;
        var stop_lat = null;

        function loadSound (name, url) {
            var request = new XMLHttpRequest();
            request.open('GET', url, true);
            request.responseType = 'arraybuffer';
            request.onload = function() {
                context.decodeAudioData(request.response, function(buffer) {
                    buffers[name] = buffer;
                    console.log("Loaded " + name + " (" + url +")");                    
                }, null);
            }
            request.send();
        }

        function playSound (name, time, volume) {
            console.log('play ' + name + ' at ' + time);
            buffer = buffers[name];
            var source = context.createBufferSource();  // creates a sound source
            source.buffer = buffer;                     // tell the source which sound to play
            var gain = context.createGainNode();        // create a gain node
            source.connect(gain);                       // connect the gain to the source
            gain.connect(context.destination);          // connect the gain to the destination
            gain.gain.value = volume;                   // set the volume
            source.noteOn(time);                        // play the source in x seconds
        }                

        function timestamp () {
            return new Date().getTime()
        }

        function checkSelection () {
            console.log("checkSelection");
            walk_index = $('#walk_select option:selected').val();
            num_walks = $('#walk_select option').length;
            if (num_walks <= 1 || walk_index.length) {
                $('#start_btn').show();
            } else {
                $('#start_btn').hide();
            }
        }

        function startWalk () {
            $('#walk_select').hide();
            $('#start_btn').hide();            
            playSound('left', 0, 0.0); // iOS needs this
            playSound('right', 0, 0.0); // iOS needs this
            setTimeout(function () { navigator.geolocation.getCurrentPosition(receiveStartGeoLocation); }, 1000);
        }

        function receiveStartGeoLocation(location) {
            start_lon = location.coords.longitude;
            start_lat = location.coords.latitude;
            startLog();            
        }                        

        function startLog () {
            $('#stop_btn').show();
            walk_index = $('#walk_select option:selected').val();
            $.ajax({
                type: 'GET',
                url: 'sequence.py',
                data: {'index': walk_index},
                dataType: 'json',
                success: function (data, textStatus, jqXHR) {
                    sequence = data['steps'];
                    var start_time = context.currentTime;
                    for (var i=0; i<4; i++) {
                        if (i % 2 == 0) {
                            playSound('left', start_time + i, 1.0);
                        } else {
                            playSound('right', start_time + i, 1.0);
                        }
                    }
                    for (note_index in sequence) {
                        var note = sequence[note_index];
                        var time = start_time + (note[0] / 1000.0) + 4;
                        var name = note[1];                        
                        playSound(name, time, 1.0);
                    }
                    setTimeout(startRecording, 4000 - 500); // half second for the accelerometer to get going
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("Sequence request failed:\n" + errorThrown);
                    console.log(jqXHR);
                    $('#walk_select').show();
                    $('#start_btn').show();     
                    $('#stop_btn').hide();                    
                }
            }); 
        }

        function startRecording () {
            $('#readings').show();
            if (start_time == null) {
                start_time = timestamp();
            }
            window.ondevicemotion = function(event) {
                var d = [timestamp(), event.accelerationIncludingGravity.x, event.accelerationIncludingGravity.y, event.accelerationIncludingGravity.z];                
                $('#display_x').html(d[1]);
                $('#display_y').html(d[2]);
                $('#display_z').html(d[3]);
                accel_data.push(d);
            }
        }

        function stopWalk () {

            function () { navigator.geolocation.getCurrentPosition(receiveStartGeoLocation); }
            stopLog();

        }

        function receiveStopGeoLocation(location) {
            stop_lon = location.coords.longitude;
            stop_lat = location.coords.latitude;
            stopLog();
        }                        

        function stopLog () {
            $('#stop_btn').hide();
            $('#readings').hide();
            window.ondevicemotion = function(event) { };
            var walk_data = {'accel_data': accel_data, 'start_location': {'lon': start_lon, 'lat': start_lat}, 'stop_location': {'lon': stop_lon, 'lat': stop_lat}, 'start_time': start_time};
            walk_data = JSON.stringify(walk_data);            
            $.ajax({
                type: 'POST',
                url: 'index.py', 
                data: {'walk_data': walk_data}, 
                success: function () {
                    alert("Success!");
                    window.location.reload();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("Log failed: " + errorThrown);
                    accel_data = [];
                    start_time = null;
                    lon = null;
                    lat = null;
                    $('#walk_select').show();
                    $('#start_btn').show();                    
                }
            });
        }

        $(document).ready(function() {                   

            navigator.geolocation.getCurrentPosition(function () { });       // just for getting permission out of the way

            $('#start_btn').hide();
            $('#stop_btn').hide();
            $('#readings').hide();            

            try {
                context = new webkitAudioContext();
            } catch(e) {
                alert("Web Audio API is not supported in this browser");
            }            

            loadSound('left', "left.wav");
            loadSound('right', "right.wav");    

            checkSelection();        

        });  

    </script>
{% endblock head %}

{% block body %}

    <select id="walk_select" onChange="checkSelection()" class="select">
        <option value=""></option>
    {% for timestamp, date in options | dictsort | reverse %}
        <option value="{{ timestamp}}">{{ date }}</a>
    {% endfor %}
    </select>
    <br />

    <input id="start_btn" class="btn" type="button" onClick="startWalk()" value="START" />
    <input id="stop_btn" class="btn" type="button" onClick="stopWalk()" value="STOP" />

    <div id="readings">
        X: <span id="display_x"></span><br />
        Y: <span id="display_y"></span><br />
        Z: <span id="display_z"></span><br />
    </div>

{% endblock body %}

